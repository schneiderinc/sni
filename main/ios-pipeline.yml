pool:
  name: Azure Pipelines
  vmImage: 'macOS-10.15'
  demands:
  - xcode
  - npm
  - npm
  - xcode

#Your build pipeline references an undefined variable named ‘APPLE_SIGNING_PROFILE_NAME’. Create or edit the build pipeline for this YAML file, define the variable on the Variables tab. See https://go.microsoft.com/fwlink/?linkid=865972

steps:
- task: Npm@1
  displayName: 'npm install --force'
  inputs:
    command: custom
    workingDir: main
    verbose: false
    customCommand: 'install --force'

- task: CmdLine@1
  displayName: 'npm install -g ionic'
  inputs:
    filename: npm
    arguments: 'install -g ionic'
    workingFolder: main

- task: CmdLine@1
  displayName: 'npm run build'
  inputs:
    filename: npm
    arguments: 'run build'
    workingFolder: main

- task: CmdLine@1
  displayName: 'npm install --g @capacitor/core @capacitor/cli'
  inputs:
    filename: npm
    arguments: 'install --g @capacitor/core @capacitor/cli'
    workingFolder: main

- task: CmdLine@1
  displayName: 'npx cap add ios'
  inputs:
    filename: npx
    arguments: 'cap add ios'
    workingFolder: main

- task: CopyFiles@2
  displayName: 'Update the Podfile'
  inputs:
    SourceFolder: main
    Contents: Podfile
    TargetFolder: main/ios/App
    OverWrite: true

- task: CocoaPods@0
  displayName: 'pod install'
  inputs:
    workingDirectory: main/ios/App
    forceRepoUpdate: true
    projectDirectory: main/ios/App

- task: CmdLine@1
  displayName: 'pod init'
  inputs:
    filename: pod
    arguments: init
    workingFolder: main/ios/App
  enabled: false

- task: CmdLine@1
  displayName: 'gem install xcpretty'
  inputs:
    filename: gem
    arguments: 'install xcpretty'
    workingFolder: main

- task: InstallAppleCertificate@2
  displayName: 'Install an Apple certificate'
  inputs:
    certSecureFile: 'e697ef95-8a27-4b32-be64-b0be9369ce43'
    certPwd: 'password-1'

- task: InstallAppleProvisioningProfile@1
  displayName: 'Install an Apple provisioning profile'
  inputs:
    provProfileSecureFile: '8f18aa80-b7c1-405b-8687-4c59ef7598bf'

- task: CopyFiles@2
  displayName: 'Replace the value of Assets.xcassets'
  inputs:
    SourceFolder: main/App.Assets/ios
    TargetFolder: main/App/App/Assets.xcassets
    OverWrite: true

- task: Xcode@5
  displayName: 'Xcode build'
  inputs:
    xcWorkspacePath: 'main/ios/App/*.xcworkspace'
    scheme: App
    packageApp: true
    signingOption: manual
    signingIdentity: 'iPhone Distribution: Cognizant Technology Solutions India Pvt Ltd'
    provisioningProfileUuid: '9f311b96-6df1-40d1-bd9e-c8dbcebcf0e1'
    provisioningProfileName: '$(APPLE_SIGNING_PROFILE_NAME)'
    workingDirectory: main/ios/App
    useXcpretty: false

- task: CopyFiles@2
  displayName: 'Copy Files to: $(Build.ArtifactStagingDirectory)'
  inputs:
    SourceFolder: '$(system.defaultworkingdirectory)'
    Contents: '**/*.ipa'
    TargetFolder: '$(Build.ArtifactStagingDirectory)'

- task: PublishBuildArtifacts@1
  displayName: 'Publish Artifact: drop'